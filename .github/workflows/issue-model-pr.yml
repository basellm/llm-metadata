name: Issue to PR (model submission)

on:
  issues:
    types: [opened, edited, labeled, reopened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to convert'
        required: true
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  issue_to_pr:
    if: |
      github.event_name == 'workflow_dispatch' || (
        github.event.issue.state == 'open' && (
          contains(github.event.issue.body, '"schema": "model-submission"') ||
          contains(github.event.issue.labels.*.name, 'model-submission')
        )
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Prepare payload
        id: payload
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          DISPATCH_ISSUE_NUMBER: ${{ inputs.issue_number }}
          EVENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ISSUE_NUM="${DISPATCH_ISSUE_NUMBER}"
          else
            ISSUE_NUM="${EVENT_ISSUE_NUMBER}"
          fi

          # Always fetch body via GH CLI to avoid script injection from raw interpolation
          ISSUE_BODY=$(gh issue view "$ISSUE_NUM" -R "$REPO" --json body -q .body)
          ISSUE_NUMBER_OUT="$ISSUE_NUM"

          echo "Extract JSON payload from issue body"
          # Extract fenced JSON block
          PAYLOAD=$(printf '%s\n' "$ISSUE_BODY" | sed -n '/^```json[[:space:]]*$/,/^```[[:space:]]*$/p' | sed '1d;$d')
          if [ -z "$PAYLOAD" ]; then
            echo "No JSON payload found in issue body" >&2
            exit 1
          fi
          echo "$PAYLOAD" > payload.json
          cat payload.json

          IS_ARRAY=$(jq -r 'if type=="array" then "1" else "0" end' payload.json)
          if [ "$IS_ARRAY" = "1" ]; then
            COUNT=$(jq 'length' payload.json)
            ACTION="batch"
            PROVIDER="batch"
            MODEL="${COUNT}-models"
            CREATE_COUNT=$(jq '[ .[] | select((.action // "create") == "create") ] | length' payload.json)
            UPDATE_COUNT=$(jq '[ .[] | select((.action // "create") == "update") ] | length' payload.json)
            PROVIDERS_SHORT=$(jq -r '[ .[] | .providerId ] | unique | .[:3] | join(", ")' payload.json)
            if [ "$CREATE_COUNT" -gt 0 ] && [ "$UPDATE_COUNT" -eq 0 ]; then
              BRANCH="feat/model-batch-add-${COUNT}-$(date -u +%Y%m%d%H%M%S)"
              COMMIT_TITLE="✨ feat(models): add ${COUNT} models (${PROVIDERS_SHORT})"
            elif [ "$UPDATE_COUNT" -gt 0 ] && [ "$CREATE_COUNT" -eq 0 ]; then
              BRANCH="chore/model-batch-update-${COUNT}-$(date -u +%Y%m%d%H%M%S)"
              COMMIT_TITLE="✏️ chore(models): update ${COUNT} models (${PROVIDERS_SHORT})"
            else
              BRANCH="chore/model-batch-mixed-${COUNT}-$(date -u +%Y%m%d%H%M%S)"
              COMMIT_TITLE="📦 chore(models): batch ${COUNT} models (create ${CREATE_COUNT}, update ${UPDATE_COUNT})"
            fi
            PR_TITLE="$COMMIT_TITLE"
          else
            ACTION=$(jq -r '.action // "create"' payload.json)
            PROVIDER=$(jq -r '.providerId' payload.json)
            MODEL=$(jq -r '.modelId' payload.json)
            PROVIDER_SAFE=$(echo "$PROVIDER" | sed 's/[^A-Za-z0-9._-]/-/g')
            MODEL_SAFE=$(echo "$MODEL" | sed 's/[^A-Za-z0-9._-]/-/g')
            if [ "$ACTION" = "update" ]; then
              BRANCH="chore/model-update-${PROVIDER_SAFE}-${MODEL_SAFE}-$(date -u +%Y%m%d%H%M%S)"
              COMMIT_TITLE="✏️ chore(models): update ${PROVIDER}/${MODEL}"
            else
              BRANCH="feat/model-add-${PROVIDER_SAFE}-${MODEL_SAFE}-$(date -u +%Y%m%d%H%M%S)"
              COMMIT_TITLE="✨ feat(models): add ${PROVIDER}/${MODEL}"
            fi
            PR_TITLE="$COMMIT_TITLE"
          fi
          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER_OUT" >> $GITHUB_OUTPUT
          echo "commit_title=$COMMIT_TITLE" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT

      - name: Create branch
        run: |
          git checkout -b "${{ steps.payload.outputs.branch }}"

      - name: Apply overrides change (scoped file)
        run: |
          set -euo pipefail
          IS_ARRAY=$(jq -r 'if type=="array" then "1" else "0" end' payload.json)
          if [ "$IS_ARRAY" = "1" ]; then
            jq -c '.[] | with_entries(select(.value != null))' payload.json | while read -r item; do
              prov=$(echo "$item" | jq -r '.providerId')
              model=$(echo "$item" | jq -r '.modelId')
              model_safe=${model//:/_}
              test -n "$prov" && test -n "$model" || continue
              mkdir -p "data/overrides/models/$prov"
              echo "$item" | jq 'with_entries(select(.value != null))' > "data/overrides/models/$prov/$model_safe.json"
            done
          else
            prov=$(jq -r '.providerId' payload.json)
            model=$(jq -r '.modelId' payload.json)
            model_safe=${model//:/_}
            mkdir -p "data/overrides/models/$prov"
            jq 'with_entries(select(.value != null))' payload.json > "data/overrides/models/$prov/$model_safe.json"
          fi

      - name: Install dependencies
        run: |
          npm ci || npm i --no-audit --no-fund
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build API (check changes)
        run: |
          npm run check || true

      - name: Commit changes
        id: commit
        env:
          PROVIDER: ${{ steps.payload.outputs.provider }}
          MODEL: ${{ steps.payload.outputs.model }}
          ISSUE_NUM: ${{ steps.payload.outputs.issue_number }}
          COMMIT_TITLE: ${{ steps.payload.outputs.commit_title }}
        run: |
          set -euo pipefail
          # Remove temporary files from working tree (not committed)
          rm -f payload.json || true
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            # Stage overrides; stage dist/api only if it exists
            git add -A data/overrides || true
            if [ -d dist/api ]; then
              git add -A dist/api || true
            fi
            git commit -m "${COMMIT_TITLE} via issue #${ISSUE_NUM}"
            git push --set-upstream origin "${{ steps.payload.outputs.branch }}"
            echo "has_changes=1" >> $GITHUB_OUTPUT
          else
            echo "No changes to commit"
            echo "has_changes=0" >> $GITHUB_OUTPUT
          fi

      - name: Open Pull Request
        if: steps.commit.outputs.has_changes == '1'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.AUTOMATION_ISSUE2PR || secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH=${{ github.event.repository.default_branch }}
          TITLE="${{ steps.payload.outputs.pr_title }}"
          gh pr create \
            --title "$TITLE" \
            --body "This PR was automatically generated from issue #${{ steps.payload.outputs.issue_number }}." \
            --base "$BASE_BRANCH" \
            --head "${{ steps.payload.outputs.branch }}"

      - name: Comment back to issue
        if: steps.commit.outputs.has_changes == '1'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.AUTOMATION_ISSUE2PR || secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr view --json url -q .url)
          gh issue comment "${{ steps.payload.outputs.issue_number }}" --body "PR created: $PR_URL"
